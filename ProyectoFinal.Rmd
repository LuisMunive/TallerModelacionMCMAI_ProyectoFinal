---
title: "Proyecto Final. Taller de Modelación Matemática I. MCMAI"
author: "Rodrigo Zúñiga Trejo & Luis Ramón Munive Hernández"
date: "Mayo 6, 2021"
output:
  pdf_document: default
header-includes: \usepackage{float}
---

\textbf{Problema-1}: El siguiente conjunto de datos representa la \textit{dirección} (ángulos $\theta_i$) que tomaron 76 tortugas después de depositar sus huevos en alguna costa de Guerrero. Los biólogos encargados del estudio desean hacer inferencias sobre la población de tortugas que depositan sus huevos en estas costas. En particular, desean describir el comportamiento de estos datos a través de un modelo estadístico que les permita hacer conclusiones probabilísticas sobre toda la población con base en esta muestra de registros. Los datos en ángulos se muestran en la siguiente Tabla, su representación gráfica se muestra en la Figura 1.

\begin{table}[H]
\begin{center}
\begin{tabular}{rrrrrrrrrrr}
\hline
8 & 27 & 45 & 53 & 64 & 73 & 88 & 96 & 138 & 226 & 257 \\
9 & 30 & 47 & 56 & 64 & 78 & 88 & 98 & 153 & 237 & 268 \\
13 & 34 & 48 & 57 & 64 & 78 & 90 & 100 & 153 & 238 & 285 \\
13 & 38 & 48 & 58 & 65 & 78 & 92 & 103 & 155 & 243 & 319 \\
14 & 38 & 48 & 58 & 65 & 83 & 92 & 106 & 204 & 244 & 343 \\
18 & 40 & 48 & 61 & 68 & 83 & 93 & 113 & 215 & 250 & 350 \\
22 & 44 & 50 & 63 & 70 & 88 & 95 & 118 & 223 & 251 & \\
\hline
\end{tabular}
\end{center}
\end{table}

```{r fig.align='center', message=FALSE, echo=FALSE, fig.cap="Direcciones de 76 tortugas, después de depositar sus huevos en la playa."}
library(CircStats)
angulosTortugas <- c(8, 27, 45, 53, 64, 73, 88, 9, 30, 47, 56, 64, 78, 88,
                    13, 34, 48, 57, 64, 78, 90, 13, 38, 48, 58, 65, 78, 92,
                    14, 38, 48, 58, 65, 83, 92, 18, 40, 48, 61, 68, 83, 93,
                    22, 44, 50, 63, 70, 88, 95, 96, 138, 226, 257, 98, 153,
                    237, 268, 100, 153, 238, 285, 103, 155, 243, 319, 106,
                    204, 244, 343, 113, 215, 250, 350, 118, 223, 251)
angulosTortugasRad <- angulosTortugas * pi / 180
circ.plot(x = angulosTortugasRad, stack = TRUE, bins = 23, shrink = 1.5, dotsep = 20, 
          main = "Datos de Tortugas")
```

Un modelo propuesto por los biólogos para modelar la variable angular $\theta$ que se propone es el siguiente

```{r}
## Kernel de la densidad de Y = log R dado theta y mu
kerY <- function(y, theta, mu) {
  b <- mu[1] * cos(theta) + mu[2] * sin(theta)
  return(exp(-0.5 * (exp(2 * y) - 2 * b * exp(y)) + 2 * y))
}

## 2. Funciones para calcular los valores iniciales  de la distribución Normal que se usará
# como distribución de transición 
media0 <- function(theta, mu){
  b <- mu[1] * cos(theta) + mu[2] * sin(theta)
  return(log(b / 2 + sqrt(b^2 + 8) / 2))
}

var0 <- function(theta, mu){
  b <- mu[1] * cos(theta) + mu[2] * sin(theta)
  return(2 / (b^2 + b * sqrt(b^2 + 8) + 8))
}

MetroHast <- function(f, theta, mu, burn, ite.inter, lag, tmues){
  # La función metro2 obtiene todos los valores de la cadena. Elimina el  periodo de calentamiento y 
  # considera los saltos (lag). Es decir, arroja ya los valores de la muestra final.
  # Author: Gabriel N
  # Date: abril 2021.
  N <- 1
  ite <- burn + ite.inter + lag * tmues
  burn.tot <- burn + ite.inter
  
  m0 <- media0(theta, mu)
  v0 <- var0(theta, mu)
  #y0 <- rnorm(N, m0, sqrt(v0))
  y0 <- 1
  #y0 <- exp(m0)
  
  y <- rep(NA, tmues)
  n.sample <- 0
  
  # Iteraciones del algoritmo
  for (j in 1 : ite)
  {
    set.seed(j+3)##########################   Fijamos semilla
    y1 <- rnorm(N, m0, sqrt(v0))
    w1 <- f(y1, theta, mu) / dnorm(y1, m0, sqrt(v0))
    w0 <- f(y0, theta, mu) / dnorm(y0, m0, sqrt(v0))
    alpha <- w1 / w0
    set.seed(j+3)##########################   Fijamos semilla
    u <- runif(N, 0, 1)
    aux <- ifelse(u <= alpha, y1, y0)
    y0 <- aux
    if(j > burn.tot & ( j %% lag) == 0){
      n.sample <- n.sample + 1
      y[n.sample] <- exp(y0)
    }
  }
  drop(y)
}

################################################################################

MHdentroGibbs <- function(theta, N){
  # Número de datos
  n <- length(theta)
  
  # Hiperparámetros de la distribución inicial para el vector mu
  lambda1_0 <- 0.001
  lambda2_0 <- 0.001
  
  #
  lambda1_n <- lambda1_0 + n
  lambda2_n <- lambda2_0 + n
  

  
  mu1 <- rep(0, N)
  mu2 <- rep(0, N)
  r <- matrix(data = 1, nrow = N, ncol = n, byrow = TRUE)
  
  for(i in 2:N){
    set.seed(i+3)##########################   Fijamos semilla
    mu1[i] <- rnorm(1, mean = lambda1_n^(-1) * (lambda1_0 * mu1[i - 1] + n * mean(r[i - 1, ] * cos(theta))), sd = 1 / sqrt(lambda1_n))
    set.seed(i+3)##########################   Fijamos semilla
    mu2[i] <- rnorm(1, mean = lambda2_n^(-1) * (lambda2_0 * mu2[i - 1] + n * mean(r[i - 1, ] * sin(theta))), sd = 1 / sqrt(lambda2_n))
    for(j in 1:n){
      r[i, j] <- MetroHast(f = kerY, theta = theta[j], mu = c(mu1[i], mu2[i]), burn = 2500, ite.inter = 500, lag = 20, tmues = 1000)[1000]
    }
  }
  return(list(mu1, mu2, r))
}

```

```{r}
tiempoInicio <- Sys.time()
datos <- (pi/180)*read.table("C:\\Users\\rodri\\OneDrive\\Documents\\escuela\\UAM\\trimestre 21-I\\Taller de modelado I\\PROYECTO\\DTP.txt", sep = "|", header = TRUE)

#prueba <- MHdentroGibbs(theta = c(pi/4, 3*pi/2), N = 10)
#prueba <- MHdentroGibbs(theta = datos[,1], N = 10)
#circ.plot(x = datos[,1], stack = TRUE, bins = 23, shrink = 1.5, dotsep = 20,main = "Datos de Tortugas prueba")
prueba <- MHdentroGibbs(theta = angulosTortugasRad, N = 100)
tiempoFin <- Sys.time()
tiempoFin - tiempoInicio
```


